<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content=rgba(0,0,0,0)><meta name=generator content="Hexo 6.3.0"><link rel=preconnect href=//fonts.loli.net crossorigin><link rel=preconnect href=null//null crossorigin><link rel=preconnect href=https://cdn.jsdelivr.net crossorigin><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><link rel=mask-icon href=/images/logo.svg color=rgba(0,0,0,0)><link rel=manifest href=/images/manifest.json><link rel=stylesheet href=/css/main.css><link rel=stylesheet href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/orange/pace-theme-big-counter.css><script src=https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin=anonymous></script><script class=next-config data-name=main type=application/json>{"hostname":"blog.csiki.org","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta name=description content="本文从skynet的main入口开始，梳理skynet运行流程，中间很多东西不会解释，必要的一些细节还是会解释滴，旨在梳理清楚skynet如何工作、启动skynet项目，发生了什么？后续将带着以下问题开始。  skynet服务如何工作？skynet服务是什么？ 服务之间如何传递信息？ 一个服务如何启动？  btw，本文需要有一定的c语言基础、lua基础以及较为重要的lua与c交互的相关知识。  m"><meta property=og:type content=blog><meta property=og:title content=skynet源码学习（粗略版）><meta property=og:url content=https://blog.csiki.org/learning/openProject/skynet/skynet-02/index.html><meta property=og:site_name content="ohayo&#39;s blog"><meta property=og:description content="本文从skynet的main入口开始，梳理skynet运行流程，中间很多东西不会解释，必要的一些细节还是会解释滴，旨在梳理清楚skynet如何工作、启动skynet项目，发生了什么？后续将带着以下问题开始。  skynet服务如何工作？skynet服务是什么？ 服务之间如何传递信息？ 一个服务如何启动？  btw，本文需要有一定的c语言基础、lua基础以及较为重要的lua与c交互的相关知识。  m"><meta property=og:locale content=zh_CN><meta property=og:image content=https://fastly.jsdelivr.net/gh/zhu-jiyuan/picture_go@master/img/Pasted%20image%2020230604183714.png><meta property=og:image content=https://fastly.jsdelivr.net/gh/zhu-jiyuan/picture_go@master/img/Pasted%20image%2020230604194028.png><meta property=og:image content=https://fastly.jsdelivr.net/gh/zhu-jiyuan/picture_go@master/img/Pasted%20image%2020230604194804.png><meta property=article:published_time content=2023-06-04T04:46:57.000Z><meta property=article:modified_time content=2023-09-03T14:05:42.468Z><meta property=article:author content=ohayo><meta property=article:tag content=openProject><meta name=twitter:card content=summary><meta name=twitter:image content=https://fastly.jsdelivr.net/gh/zhu-jiyuan/picture_go@master/img/Pasted%20image%2020230604183714.png><link rel=canonical href=https://blog.csiki.org/learning/openProject/skynet/skynet-02/ ><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.csiki.org/learning/openProject/skynet/skynet-02/","path":"learning/openProject/skynet/skynet-02/","title":"skynet源码学习（粗略版）"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>skynet源码学习（粗略版） | ohayo's blog</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><p class=site-title>ohayo's blog</p><i class=logo-line></i></a></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-journal"><a href=/categories/journal/index.html rel=section><i class="fa fa-book-journal-whills fa-fw"></i>Journal</a></li><li class="menu-item menu-item-test"><a href=https://test.ohayo.live/ rel=noopener target=_blank><i class="fa fa-book fa-fw"></i>Test</a></li><li class="menu-item menu-item-friend"><a href=/friends/index.html rel=section><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href=/about/index.html rel=section><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-search"><a role=button class=popup-trigger><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#main%E5%85%A5%E5%8F%A3><span class=nav-number>1.</span> <span class=nav-text>main入口</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B><span class=nav-number>2.</span> <span class=nav-text>启动流程</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA><span class=nav-number>3.</span> <span class=nav-text>线程创建</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8><span class=nav-number>4.</span> <span class=nav-text>服务启动</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=ohayo src=/images/avatar.png><p class=site-author-name itemprop=name>ohayo</p><div class=site-description itemprop=description></div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/ ><span class=site-state-item-count>25</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/ ><span class=site-state-item-count>18</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/ ><span class=site-state-item-count>14</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class=links-of-author-item><a href=https://github.com/zhu-jiyuan title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhu-jiyuan" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class=links-of-author-item><a href=mailto:ohayo1213@outlook.com title="E-Mail → mailto:ohayo1213@outlook.com" rel=noopener target=_blank><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class=links-of-author-item><a href=/atom.xml title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a></span></div></div></div><div class="back-to-top animated" role=button aria-label=返回顶部><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class=sidebar-dimmer></div></header><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang=zh-CN><link itemprop=mainEntityOfPage href=https://blog.csiki.org/learning/openProject/skynet/skynet-02/ ><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/avatar.png><meta itemprop=name content=ohayo></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ohayo's blog"><meta itemprop=description content=""></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="skynet源码学习（粗略版） | ohayo's blog"><meta itemprop=description content=""></span><header class=post-header><h1 class=post-title itemprop="name headline">skynet源码学习（粗略版）</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i> </span><span class=post-meta-item-text>发表于</span> <time title="创建时间：2023-06-04 12:46:57" itemprop="dateCreated datePublished" datetime=2023-06-04T12:46:57+08:00>2023-06-04</time> </span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i> </span><span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-09-03 22:05:42" itemprop=dateModified datetime=2023-09-03T22:05:42+08:00>2023-09-03</time> </span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i> </span><span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/skynet/ itemprop=url rel=index><span itemprop=name>skynet</span></a> </span></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-comment"></i> </span><span class=post-meta-item-text>Disqus：</span> <a title=disqus href=/learning/openProject/skynet/skynet-02/#disqus_thread itemprop=discussionUrl><span class="post-comments-count disqus-comment-count" data-disqus-identifier=learning/openProject/skynet/skynet-02/ itemprop=commentCount></span></a></span></div></div></header><div class=post-body itemprop=articleBody><p>本文从skynet的main入口开始，梳理skynet运行流程，中间很多东西不会解释，必要的一些细节还是会解释滴，旨在梳理清楚skynet如何工作、启动skynet项目，发生了什么？后续将带着以下问题开始。</p><ul><li>skynet服务如何工作？skynet服务是什么？</li><li>服务之间如何传递信息？</li><li>一个服务如何启动？</li></ul><p>btw，本文需要有一定的c语言基础、lua基础以及较为重要的lua与c交互的相关知识。</p><h2 id=main入口><a class=markdownIt-Anchor href=#main入口></a> main入口</h2><p>main函数首先，检测了配置文件，配置节点，TSD，初始化skynet环境，设置信号量。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">struct</span> <span class="token class-name">lua_State</span> <span class="token operator">*</span>L <span class="token operator">=</span> <span class="token function">luaL_newstate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">luaL_openlibs</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// link lua lib</span>
<span class="token keyword">int</span> err <span class="token operator">=</span>  <span class="token function">luaL_loadbufferx</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> load_config<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>load_config<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=[skynet config]"</span><span class="token punctuation">,</span> <span class="token string">"t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>err <span class="token operator">==</span> LUA_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">lua_pushstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> config_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
err <span class="token operator">=</span> <span class="token function">lua_pcall</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token function">lua_tostring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_close</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">_init_env</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>thread <span class="token operator">=</span>  <span class="token function">optint</span><span class="token punctuation">(</span><span class="token string">"thread"</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>module_path <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span><span class="token string">"cpath"</span><span class="token punctuation">,</span><span class="token string">"./cservice/?.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>harbor <span class="token operator">=</span> <span class="token function">optint</span><span class="token punctuation">(</span><span class="token string">"harbor"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>bootstrap <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span><span class="token string">"bootstrap"</span><span class="token punctuation">,</span><span class="token string">"snlua bootstrap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span><span class="token string">"daemon"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span><span class="token string">"logger"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>logservice <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span><span class="token string">"logservice"</span><span class="token punctuation">,</span> <span class="token string">"logger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>profile <span class="token operator">=</span> <span class="token function">optboolean</span><span class="token punctuation">(</span><span class="token string">"profile"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">lua_close</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>main中创建了一个lua栈，把配置文件的内容压入栈里，通过lua脚本，设置到skynet环境中。</p><pre class="line-numbers language-c" data-language=c><code class=language-c>#加载config的lua脚本
 <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> load_config <span class="token operator">=</span> <span class="token string">"\
	local result = &#123;&#125;\n\
	local function getenv(name) return assert(os.getenv(name), [[os.getenv() failed: ]] .. name) end\n\
	local sep = package.config:sub(1,1)\n\
	local current_path = [[.]]..sep\n\
	local function include(filename)\n\
		local last_path = current_path\n\
		local path, name = filename:match([[(.*]]..sep..[[)(.*)$]])\n\
		if path then\n\
			if path:sub(1,1) == sep then	-- root\n\
				current_path = path\n\
			else\n\
				current_path = current_path .. path\n\
			end\n\
		else\n\
			name = filename\n\
		end\n\
		local f = assert(io.open(current_path .. name))\n\
		local code = assert(f:read [[*a]])\n\
		code = string.gsub(code, [[%$([%w_%d]+)]], getenv)\n\
		f:close()\n\
		assert(load(code,[[@]]..filename,[[t]],result))()\n\
		current_path = last_path\n\
	end\n\
	setmetatable(result, &#123; __index = &#123; include = include &#125; &#125;)\n\
	local config_name = ...\n\
	include(config_name)\n\
	setmetatable(result, nil)\n\
	return result\n\
"</span><span class="token punctuation">;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>后续就可以通过skynet环境读取到配置文件的信息啦。</p><pre class="line-numbers language-c" data-language=c><code class=language-c>config<span class="token punctuation">.</span>thread <span class="token operator">=</span>  <span class="token function">optint</span><span class="token punctuation">(</span><span class="token string">"thread"</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>module_path <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span><span class="token string">"cpath"</span><span class="token punctuation">,</span><span class="token string">"./cservice/?.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>harbor <span class="token operator">=</span> <span class="token function">optint</span><span class="token punctuation">(</span><span class="token string">"harbor"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>bootstrap <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span><span class="token string">"bootstrap"</span><span class="token punctuation">,</span><span class="token string">"snlua bootstrap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span><span class="token string">"daemon"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span><span class="token string">"logger"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>logservice <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span><span class="token string">"logservice"</span><span class="token punctuation">,</span> <span class="token string">"logger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>profile <span class="token operator">=</span> <span class="token function">optboolean</span><span class="token punctuation">(</span><span class="token string">"profile"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们拿<code>config.thread = optint(&quot;thread&quot;,8);</code>举例，后面optstring都是类似的。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">optint</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> opt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> str <span class="token operator">=</span> <span class="token function">skynet_getenv</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//如果配置文件没有配置这个key，就用默认的参数，在optint("thread",8)中就是8.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">char</span> tmp<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span><span class="token string">"%d"</span><span class="token punctuation">,</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">skynet_setenv</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//把默认的参数写入skynet环境中。</span>
		<span class="token keyword">return</span> opt<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token function">strtol</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//配置文件中有key的配置，把字符串转int值返回。</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>加载完配置文件后，会关闭临时用的lua栈，然后来到最重要的环节----根据配置，启动skynet。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token function">skynet_start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// &lt;==我们主要通过这个，就可以知道skynet的启动流程了</span>
<span class="token function">skynet_globalexit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><h2 id=启动流程><a class=markdownIt-Anchor href=#启动流程></a> 启动流程</h2><p><code>skynet_start</code>中，首先也注册了信号量，紧接着检测是否设置为守护进程。</p><p>后面的部分，才是我们主要分析的地方。<br>这个函数首先进行了节点、handle、消息队列、模块、定时器、socket的初始化以及开启性能分析。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token function">skynet_harbor_init</span><span class="token punctuation">(</span>config<span class="token operator">-></span>harbor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">skynet_handle_init</span><span class="token punctuation">(</span>config<span class="token operator">-></span>harbor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">skynet_mq_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">skynet_module_init</span><span class="token punctuation">(</span>config<span class="token operator">-></span>module_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">skynet_timer_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">skynet_socket_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">skynet_profile_enable</span><span class="token punctuation">(</span>config<span class="token operator">-></span>profile<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们知道skynet中服务地址的构成。高八位是节点地址，低24位是服务地址。<br><img data-src=https://fastly.jsdelivr.net/gh/zhu-jiyuan/picture_go@master/img/Pasted%20image%2020230604183714.png alt="Pasted image 20230604183714"></p><p>而<code>skynet_harbor_init</code>仅仅只做了一件事，把高8位设置为配置文件的节点号。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">void</span>
<span class="token function">skynet_harbor_init</span><span class="token punctuation">(</span><span class="token keyword">int</span> harbor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	HARBOR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>harbor <span class="token operator">&lt;&lt;</span> HANDLE_REMOTE_SHIFT<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>skynet_handle_init</code>中主要为了，初始化一张全局handle操作的<code>地址表H</code>。<br><code>skynet_mq_init</code>中创建一个全局队列。<br><code>skynet_module_init</code>中创建了一个全局模块表，这样可以避免模块重复加载等等。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">struct</span> <span class="token class-name">modules</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> count<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> path<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">skynet_module</span> m<span class="token punctuation">[</span>MAX_MODULE_TYPE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>skynet_timer_init</code>中创建了一个全局定时器，用于更新时间。<br><code>skynet_socket_init</code>中根据定时器提供的当前时间创建了一个socket_server，用与管理socket相关操作。</p><hr><p>接下来skynet启动了第一个服务——日志服务。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token function">skynet_context_new</span><span class="token punctuation">(</span>config<span class="token operator">-></span>logservice<span class="token punctuation">,</span> config<span class="token operator">-></span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Can't launch %s service\n"</span><span class="token punctuation">,</span> config<span class="token operator">-></span>logservice<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">skynet_handle_namehandle</span><span class="token punctuation">(</span><span class="token function">skynet_context_handle</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"logger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们主要分析skynet_context_new这个函数，而skynet_handle_namehandle函数非常简单，它的作用是给服务起个名字，并插入到handle全局表H中，这里不过多展开了。</p><p>skynet_context_new函数首先会查询服务的模块名。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">struct</span> <span class="token class-name">skynet_module</span> <span class="token operator">*</span> mod <span class="token operator">=</span> <span class="token function">skynet_module_query</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>mod <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token comment">//skynet_module_query</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里需要分析一下mod 查询函数</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">struct</span> <span class="token class-name">skynet_module</span> <span class="token operator">*</span> 
<span class="token function">skynet_module_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// _query会去全局模块表M中找，看之前是否打开过该模块。如果打开过直接返回。</span>
	<span class="token keyword">struct</span> <span class="token class-name">skynet_module</span> <span class="token operator">*</span> result <span class="token operator">=</span> <span class="token function">_query</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>

	<span class="token function">SPIN_LOCK</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span>

	result <span class="token operator">=</span> <span class="token function">_query</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// double check</span>
	<span class="token comment">//如果之前没有打开过，会去设置的模块路径中查找对应的模块，进行打开。</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> M<span class="token operator">-></span>count <span class="token operator">&lt;</span> MAX_MODULE_TYPE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">int</span> index <span class="token operator">=</span> M<span class="token operator">-></span>count<span class="token punctuation">;</span>
		<span class="token keyword">void</span> <span class="token operator">*</span> dl <span class="token operator">=</span> <span class="token function">_try_open</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>dl<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			M<span class="token operator">-></span>m<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
			M<span class="token operator">-></span>m<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>module <span class="token operator">=</span> dl<span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">open_sym</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>M<span class="token operator">-></span>m<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				M<span class="token operator">-></span>m<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token function">skynet_strdup</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
				M<span class="token operator">-></span>count <span class="token operator">++</span><span class="token punctuation">;</span>
				result <span class="token operator">=</span> <span class="token operator">&amp;</span>M<span class="token operator">-></span>m<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">SPIN_UNLOCK</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span>
	<span class="token comment">//打开成功返回skynet_module*，否则是NULL</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>模块打开后，会对模块实例化。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">void</span> <span class="token operator">*</span>inst <span class="token operator">=</span> <span class="token function">skynet_module_instance_create</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>inst <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token function">skynet_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span></span></code></pre><p>实例化会调用模块中的回调函数。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">void</span> <span class="token operator">*</span> 
<span class="token function">skynet_module_instance_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_module</span> <span class="token operator">*</span>m<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token operator">-></span>create<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> m<span class="token operator">-></span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里有一个问题，这个回调函数<code>m-&gt;create()</code>怎么来的。<br>这个回调函数的绑定是在查询阶段调用<code>open_sym</code>函数实现的。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">get_api</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_module</span> <span class="token operator">*</span>mod<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>api_name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">size_t</span> name_size <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>mod<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> api_size <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>api_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> tmp<span class="token punctuation">[</span>name_size <span class="token operator">+</span> api_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> mod<span class="token operator">-></span>name<span class="token punctuation">,</span> name_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>tmp<span class="token operator">+</span>name_size<span class="token punctuation">,</span> api_name<span class="token punctuation">,</span> api_size<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ptr <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		ptr <span class="token operator">=</span> ptr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token function">dlsym</span><span class="token punctuation">(</span>mod<span class="token operator">-></span>module<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">open_sym</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_module</span> <span class="token operator">*</span>mod<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	mod<span class="token operator">-></span>create <span class="token operator">=</span> <span class="token function">get_api</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">"_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	mod<span class="token operator">-></span>init <span class="token operator">=</span> <span class="token function">get_api</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">"_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	mod<span class="token operator">-></span>release <span class="token operator">=</span> <span class="token function">get_api</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">"_release"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	mod<span class="token operator">-></span>signal <span class="token operator">=</span> <span class="token function">get_api</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">"_signal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> mod<span class="token operator">-></span>init <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接着回到服务的创建函数，下面都是对服务的初始化。</p><pre class="line-numbers language-c" data-language=c><code class=language-c>ctx<span class="token operator">-></span>mod <span class="token operator">=</span> mod<span class="token punctuation">;</span>
ctx<span class="token operator">-></span>instance <span class="token operator">=</span> inst<span class="token punctuation">;</span>
<span class="token function">ATOM_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx<span class="token operator">-></span>ref <span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token operator">-></span>cb <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
ctx<span class="token operator">-></span>cb_ud <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
ctx<span class="token operator">-></span>session_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">ATOM_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx<span class="token operator">-></span>logfile<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ctx<span class="token operator">-></span>init <span class="token operator">=</span> false<span class="token punctuation">;</span>
ctx<span class="token operator">-></span>endless <span class="token operator">=</span> false<span class="token punctuation">;</span>

ctx<span class="token operator">-></span>cpu_cost <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
ctx<span class="token operator">-></span>cpu_start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
ctx<span class="token operator">-></span>message_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
ctx<span class="token operator">-></span>profile <span class="token operator">=</span> G_NODE<span class="token punctuation">.</span>profile<span class="token punctuation">;</span>
<span class="token comment">// Should set to 0 first to avoid skynet_handle_retireall get an uninitialized handle</span>
ctx<span class="token operator">-></span>handle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	
ctx<span class="token operator">-></span>handle <span class="token operator">=</span> <span class="token function">skynet_handle_register</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//注册一个handle地址</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>紧接着重点来了，服务创建了一个消息队列，并调用模块的初始化函数，对其进行初始化，如果初始化成功，就把这个服务的消息队列推入skynet的全局中并返回ctx，否则创建服务失败，释放相关资源。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">struct</span> <span class="token class-name">message_queue</span> <span class="token operator">*</span> queue <span class="token operator">=</span> ctx<span class="token operator">-></span>queue <span class="token operator">=</span> <span class="token function">skynet_mq_create</span><span class="token punctuation">(</span>ctx<span class="token operator">-></span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// init function maybe use ctx->handle, so it must init at last</span>
<span class="token function">context_inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">CHECKCALLING_BEGIN</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">skynet_module_instance_init</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> inst<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">CHECKCALLING_END</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token function">skynet_context_release</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ctx<span class="token operator">-></span>init <span class="token operator">=</span> true<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">skynet_globalmq_push</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_error</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> <span class="token string">"LAUNCH %s %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> param <span class="token operator">?</span> param <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
	<span class="token function">skynet_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"FAILED launch %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span> handle <span class="token operator">=</span> ctx<span class="token operator">-></span>handle<span class="token punctuation">;</span>
	<span class="token function">skynet_context_release</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">skynet_handle_retire</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">drop_t</span> d <span class="token operator">=</span> <span class="token punctuation">&#123;</span> handle <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token function">skynet_mq_release</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> drop_message<span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里的函数都不难理解，就不做展开了。</p><p>到这里一个服务就创建好了，可以得到结论，服务其实就是一个<code>skynet_context</code>结构体。</p><hr><p>接下来到了<code>bootstrap(ctx, config-&gt;bootstrap);</code>这步，这步的作用是启动的服务，这行代码，连接lua层，比较难，放到最后再说，不妨先理解为启动其他服务。</p><h2 id=线程创建><a class=markdownIt-Anchor href=#线程创建></a> 线程创建</h2><p>在各个服务都创建好后，到了<code>start(config-&gt;thread);</code>，就开始创建服务的处理线程了。<br>这里要先用几个图解释一下。<br>当服务创建好后，它的消息队列会push到skynet全局队列GQ中。<br>而服务本身有一个skynet_message队列，这个队列是存放其他服务发的消息的。<br><img data-src=https://fastly.jsdelivr.net/gh/zhu-jiyuan/picture_go@master/img/Pasted%20image%2020230604194028.png alt="Pasted image 20230604194028"><br>全局队列中的每个消息队列对应一个服务，而其他服务发送需要处理的消息在消息队列中的skynet_message队列中。需要注意的是，全局队列是链表的形式，而skynet_message队列是数组循环队列。</p><p><code>start(config-&gt;thread);</code>会创建很多工作线程，这些工作线程从GQ中，抢消息队列，如果消息队列中有消息，就用消息队列对应服务的回调函数处理这条消息。</p><p><img data-src=https://fastly.jsdelivr.net/gh/zhu-jiyuan/picture_go@master/img/Pasted%20image%2020230604194804.png alt="Pasted image 20230604194804"></p><p>下面开始从源码分析这些线程是怎么创建与工作的。<br>在创建这些工作线程之前，先创建了监视器、定时器、socket三个线程，而监视器线程中有与工作线程数量对应的skynet_monitor监视器。<br>这里的在创建定时器和socket线程时也传入了监视器实例，主要目的是为了通过监视器实例来控制工作线程。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token class-name">pthread_t</span> pid<span class="token punctuation">[</span>thread<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">monitor</span> <span class="token operator">*</span>m <span class="token operator">=</span> <span class="token function">skynet_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m<span class="token operator">-></span>count <span class="token operator">=</span> thread<span class="token punctuation">;</span>
m<span class="token operator">-></span>sleep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

m<span class="token operator">-></span>m <span class="token operator">=</span> <span class="token function">skynet_malloc</span><span class="token punctuation">(</span>thread <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_monitor</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>thread<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	m<span class="token operator">-></span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">skynet_monitor_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token operator">-></span>mutex<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Init mutex error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token operator">-></span>cond<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Init cond error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">create_thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> thread_monitor<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">create_thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> thread_timer<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">create_thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> thread_socket<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而后才创建了工作线程，在创建工作线程时，对每个线程附加了权重还传入了对应的skynet_monitor监视器。这个权重稍后解释。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">int</span> weight<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> 
	<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> 
	<span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> 
	<span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">worker_parm</span> wp<span class="token punctuation">[</span>thread<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>thread<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	wp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>m <span class="token operator">=</span> m<span class="token punctuation">;</span>
	wp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">=</span> i<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>weight<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		wp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token operator">=</span> weight<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		wp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">create_thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> thread_worker<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>thread<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>pid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span>

<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>不妨看看<code>thread_worker</code>做了什么。</p><p>首先通过获取权重，并通过全局监视器获取skynet_monitor监视器。当监视器没有离开时，重复循环。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">thread_worker</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">worker_parm</span> <span class="token operator">*</span>wp <span class="token operator">=</span> p<span class="token punctuation">;</span>
	<span class="token keyword">int</span> id <span class="token operator">=</span> wp<span class="token operator">-></span>id<span class="token punctuation">;</span>
	<span class="token keyword">int</span> weight <span class="token operator">=</span> wp<span class="token operator">-></span>weight<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">monitor</span> <span class="token operator">*</span>m <span class="token operator">=</span> wp<span class="token operator">-></span>m<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">skynet_monitor</span> <span class="token operator">*</span>sm <span class="token operator">=</span> m<span class="token operator">-></span>m<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">skynet_initthread</span><span class="token punctuation">(</span>THREAD_WORKER<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">message_queue</span> <span class="token operator">*</span> q <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token operator">-></span>quit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		q <span class="token operator">=</span> <span class="token function">skynet_context_message_dispatch</span><span class="token punctuation">(</span>sm<span class="token punctuation">,</span> q<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token operator">-></span>mutex<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token operator">++</span> m<span class="token operator">-></span>sleep<span class="token punctuation">;</span>
				<span class="token comment">// "spurious wakeup" is harmless,</span>
				<span class="token comment">// because skynet_context_message_dispatch() can be call at any time.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token operator">-></span>quit<span class="token punctuation">)</span>
					<span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token operator">-></span>cond<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token operator">--</span> m<span class="token operator">-></span>sleep<span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"unlock mutex error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中<code>skynet_context_message_dispatch</code>函数是关键。</p><p>这个函数首先从全局队列GQ中获取消息队列。然后从消息队列中获取handle，再从handle中获取到服务上下文。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	q <span class="token operator">=</span> <span class="token function">skynet_globalmq_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">uint32_t</span> handle <span class="token operator">=</span> <span class="token function">skynet_mq_handle</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token function">skynet_handle_grab</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">drop_t</span> d <span class="token operator">=</span> <span class="token punctuation">&#123;</span> handle <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token function">skynet_mq_release</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> drop_message<span class="token punctuation">,</span> <span class="token operator">&amp;</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">skynet_globalmq_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>之后就是对消息队列中skynet_message队列进行处理，这里可以知道，权重的作用。</p><table><thead><tr><th>权重</th><th>消息处理数量</th></tr></thead><tbody><tr><td>-1</td><td>1条</td></tr><tr><td>0</td><td>全部消息</td></tr><tr><td>1</td><td>一半消息</td></tr><tr><td>2</td><td>1/4消息</td></tr><tr><td>3</td><td>1/8消息</td></tr></tbody></table><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">int</span> i<span class="token punctuation">,</span>n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">skynet_message</span> msg<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">skynet_mq_pop</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_context_release</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">skynet_globalmq_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> weight <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		n <span class="token operator">=</span> <span class="token function">skynet_mq_length</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
		n <span class="token operator">>>=</span> weight<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">int</span> overload <span class="token operator">=</span> <span class="token function">skynet_mq_overload</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>overload<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"May overload, message queue length = %d"</span><span class="token punctuation">,</span> overload<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">skynet_monitor_trigger</span><span class="token punctuation">(</span>sm<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>source <span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>cb <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_free</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token function">dispatch_message</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">skynet_monitor_trigger</span><span class="token punctuation">(</span>sm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里的监视器触发函数<code>skynet_monitor_trigger</code>，主要是为了防止服务死循环。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">void</span> 
<span class="token function">skynet_monitor_trigger</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_monitor</span> <span class="token operator">*</span>sm<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> source<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> destination<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	sm<span class="token operator">-></span>source <span class="token operator">=</span> source<span class="token punctuation">;</span>
	sm<span class="token operator">-></span>destination <span class="token operator">=</span> destination<span class="token punctuation">;</span>
	<span class="token function">ATOM_FINC</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sm<span class="token operator">-></span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> 
<span class="token function">skynet_monitor_check</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_monitor</span> <span class="token operator">*</span>sm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sm<span class="token operator">-></span>version <span class="token operator">==</span> sm<span class="token operator">-></span>check_version<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sm<span class="token operator">-></span>destination<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">skynet_context_endless</span><span class="token punctuation">(</span>sm<span class="token operator">-></span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">skynet_error</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"A message from [ :%08x ] to [ :%08x ] maybe in an endless loop (version = %d)"</span><span class="token punctuation">,</span> sm<span class="token operator">-></span>source <span class="token punctuation">,</span> sm<span class="token operator">-></span>destination<span class="token punctuation">,</span> sm<span class="token operator">-></span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		sm<span class="token operator">-></span>check_version <span class="token operator">=</span> sm<span class="token operator">-></span>version<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在监视器线程中，会不断检查工作线程的<code>skynet_monitor</code>。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">thread_monitor</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">monitor</span> <span class="token operator">*</span> m <span class="token operator">=</span> p<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">int</span> n <span class="token operator">=</span> m<span class="token operator">-></span>count<span class="token punctuation">;</span>
	<span class="token function">skynet_initthread</span><span class="token punctuation">(</span>THREAD_MONITOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		CHECK_ABORT
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">skynet_monitor_check</span><span class="token punctuation">(</span>m<span class="token operator">-></span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			CHECK_ABORT
			<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再次回到工作线程中的<code>skynet_context_message_dispatch</code>函数，在服务有注册回调函数时，会调用<code>dispatch_message</code>进行处理，而这个函数会调用服务的回调进行消息处理。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">dispatch_message</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">skynet_message</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token operator">-></span>init<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CHECKCALLING_BEGIN</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token function">pthread_setspecific</span><span class="token punctuation">(</span>G_NODE<span class="token punctuation">.</span>handle_key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token operator">-></span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> type <span class="token operator">=</span> msg<span class="token operator">-></span>sz <span class="token operator">>></span> MESSAGE_TYPE_SHIFT<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> sz <span class="token operator">=</span> msg<span class="token operator">-></span>sz <span class="token operator">&amp;</span> MESSAGE_TYPE_MASK<span class="token punctuation">;</span>
	FILE <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ATOM_LOAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx<span class="token operator">-></span>logfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_log_output</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> msg<span class="token operator">-></span>source<span class="token punctuation">,</span> type<span class="token punctuation">,</span> msg<span class="token operator">-></span>session<span class="token punctuation">,</span> msg<span class="token operator">-></span>data<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token operator">++</span>ctx<span class="token operator">-></span>message_count<span class="token punctuation">;</span>
	<span class="token keyword">int</span> reserve_msg<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>profile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ctx<span class="token operator">-></span>cpu_start <span class="token operator">=</span> <span class="token function">skynet_thread_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		reserve_msg <span class="token operator">=</span> ctx<span class="token operator">-></span><span class="token function">cb</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token operator">-></span>cb_ud<span class="token punctuation">,</span> type<span class="token punctuation">,</span> msg<span class="token operator">-></span>session<span class="token punctuation">,</span> msg<span class="token operator">-></span>source<span class="token punctuation">,</span> msg<span class="token operator">-></span>data<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">uint64_t</span> cost_time <span class="token operator">=</span> <span class="token function">skynet_thread_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ctx<span class="token operator">-></span>cpu_start<span class="token punctuation">;</span>
		ctx<span class="token operator">-></span>cpu_cost <span class="token operator">+=</span> cost_time<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		reserve_msg <span class="token operator">=</span> ctx<span class="token operator">-></span><span class="token function">cb</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token operator">-></span>cb_ud<span class="token punctuation">,</span> type<span class="token punctuation">,</span> msg<span class="token operator">-></span>session<span class="token punctuation">,</span> msg<span class="token operator">-></span>source<span class="token punctuation">,</span> msg<span class="token operator">-></span>data<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reserve_msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_free</span><span class="token punctuation">(</span>msg<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">CHECKCALLING_END</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如此，服务如何运行的问题就基本解决了。就是通过这些工作线程不断从GQ中获取服务的消息队列，再调用服务注册的回调函数处理消息。</p><hr><p>让我们回到<code>bootstrap(ctx, config-&gt;bootstrap);</code>服务启动这部分。</p><h2 id=服务启动><a class=markdownIt-Anchor href=#服务启动></a> 服务启动</h2><p>bootstrap函数如下，举个例子，传入的是默认参数日志服务和<code>snlua bootstrap</code></p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> logger<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> cmdline<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> name<span class="token punctuation">[</span>sz<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> args<span class="token punctuation">[</span>sz<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> arg_pos<span class="token punctuation">;</span> 
	<span class="token function">sscanf</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	arg_pos <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>arg_pos <span class="token operator">&lt;</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">[</span>arg_pos<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">' '</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			arg_pos<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token function">strncpy</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> cmdline <span class="token operator">+</span> arg_pos<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token function">skynet_context_new</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_error</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"Bootstrap error : %s\n"</span><span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">skynet_context_dispatchall</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个函数会执行<code>struct skynet_context *ctx = skynet_context_new(&quot;snlua&quot;, &quot;bootstrap&quot;);</code>创建一个snlua服务。<br>snlua全名是skynet lua，它是作者自定义的lua虚拟机。<br>创建时，会建一个lua栈，并初始化变量。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">struct</span> <span class="token class-name">snlua</span> <span class="token punctuation">&#123;</span>
	lua_State <span class="token operator">*</span> L<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> ctx<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> mem<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> mem_report<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> mem_limit<span class="token punctuation">;</span>
	lua_State <span class="token operator">*</span> activeL<span class="token punctuation">;</span>
	ATOM_INT trap<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">snlua</span> <span class="token operator">*</span>
<span class="token function">snlua_create</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">snlua</span> <span class="token operator">*</span> l <span class="token operator">=</span> <span class="token function">skynet_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	l<span class="token operator">-></span>mem_report <span class="token operator">=</span> MEMORY_WARNING_REPORT<span class="token punctuation">;</span>
	l<span class="token operator">-></span>mem_limit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	l<span class="token operator">-></span>L <span class="token operator">=</span> <span class="token function">lua_newstate</span><span class="token punctuation">(</span>lalloc<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>
	l<span class="token operator">-></span>activeL <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">ATOM_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token operator">-></span>trap <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> l<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span>

<span class="token function">snlua_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snlua</span> <span class="token operator">*</span>l<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span> tmp <span class="token operator">=</span> <span class="token function">skynet_malloc</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> args<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">skynet_callback</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> l <span class="token punctuation">,</span> launch_cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> self <span class="token operator">=</span> <span class="token function">skynet_command</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"REG"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span> handle_id <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>self<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// it must be first message</span>
	<span class="token function">skynet_send</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> handle_id<span class="token punctuation">,</span> PTYPE_TAG_DONTCOPY<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个服务的重点在于初始化操作，它首先通过<code>skynet_callback</code>函数设置了自己的回调函数为<code>launch_cb</code>，还拿具体例子，这个参数是默认参数&quot;bootstrap&quot;。<br><code>const char * self = skynet_command(ctx, &quot;REG&quot;, NULL);</code>这段代码如果最后的参数会NULL或<code>\0</code>返回服务的handle，如果<code>.name</code>则给服务注册名字。<br>而<code>uint32_t handle_id = strtoul(self+1, NULL, 16);</code>这里的<code>self+1</code>是因为self是16进制字符串，第一位是<code>:</code>。<br>最后向自己发一条消息，让工作线程去处理它。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">command_func</span> cmd_funcs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"TIMEOUT"</span><span class="token punctuation">,</span> cmd_timeout <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"REG"</span><span class="token punctuation">,</span> cmd_reg <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"QUERY"</span><span class="token punctuation">,</span> cmd_query <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"NAME"</span><span class="token punctuation">,</span> cmd_name <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"EXIT"</span><span class="token punctuation">,</span> cmd_exit <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"KILL"</span><span class="token punctuation">,</span> cmd_kill <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"LAUNCH"</span><span class="token punctuation">,</span> cmd_launch <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"GETENV"</span><span class="token punctuation">,</span> cmd_getenv <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"SETENV"</span><span class="token punctuation">,</span> cmd_setenv <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"STARTTIME"</span><span class="token punctuation">,</span> cmd_starttime <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"ABORT"</span><span class="token punctuation">,</span> cmd_abort <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"MONITOR"</span><span class="token punctuation">,</span> cmd_monitor <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"STAT"</span><span class="token punctuation">,</span> cmd_stat <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"LOGON"</span><span class="token punctuation">,</span> cmd_logon <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"LOGOFF"</span><span class="token punctuation">,</span> cmd_logoff <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"SIGNAL"</span><span class="token punctuation">,</span> cmd_signal <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> 
<span class="token function">skynet_command</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> context<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> cmd <span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">command_func</span> <span class="token operator">*</span> method <span class="token operator">=</span> <span class="token operator">&amp;</span>cmd_funcs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>method<span class="token operator">-></span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> method<span class="token operator">-></span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> method<span class="token operator">-></span><span class="token function">func</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token operator">++</span>method<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>
<span class="token function">cmd_reg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> context<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> param<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>context<span class="token operator">-></span>result<span class="token punctuation">,</span> <span class="token string">":%x"</span><span class="token punctuation">,</span> context<span class="token operator">-></span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> context<span class="token operator">-></span>result<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">skynet_handle_namehandle</span><span class="token punctuation">(</span>context<span class="token operator">-></span>handle<span class="token punctuation">,</span> param <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_error</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"Can't register global name %s in C"</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当工作线程拿到这条信息时，就会回调<code>launch_cb</code>函数，这里有把snlua服务的回调函数设置为NULL了，这是因为snlua只进行一次运行初始化即可，这里设置为NULL，可以保护服务初始化，而后续会把回调设置成其他。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">launch_cb</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> context<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ud<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> session<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> source <span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> msg<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">assert</span><span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> session <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">snlua</span> <span class="token operator">*</span>l <span class="token operator">=</span> ud<span class="token punctuation">;</span>
	<span class="token function">skynet_callback</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">init_cb</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> context<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_command</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"EXIT"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>继续调用<code>init_cb</code>，这是snlua的核心，它通过lua与c的交互，设置了环境，为了统计时间，重置了协程函数，同时设置了lua寻找模块的路径。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">init_cb</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">snlua</span> <span class="token operator">*</span>l<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> args<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	lua_State <span class="token operator">*</span>L <span class="token operator">=</span> l<span class="token operator">-></span>L<span class="token punctuation">;</span>
	l<span class="token operator">-></span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
	<span class="token function">lua_gc</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> LUA_GCSTOP<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pushboolean</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* signal for libraries to ignore env. vars. */</span>
	<span class="token function">lua_setfield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> LUA_REGISTRYINDEX<span class="token punctuation">,</span> <span class="token string">"LUA_NOENV"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">luaL_openlibs</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">luaL_requiref</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"skynet.profile"</span><span class="token punctuation">,</span> init_profile<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> profile_lib <span class="token operator">=</span> <span class="token function">lua_gettop</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// replace coroutine.resume / coroutine.wrap</span>
	<span class="token function">lua_getglobal</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"coroutine"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_getfield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> profile_lib<span class="token punctuation">,</span> <span class="token string">"resume"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_setfield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"resume"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_getfield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> profile_lib<span class="token punctuation">,</span> <span class="token string">"wrap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_setfield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"wrap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lua_settop</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> profile_lib<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lua_pushlightuserdata</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_setfield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> LUA_REGISTRYINDEX<span class="token punctuation">,</span> <span class="token string">"skynet_context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">luaL_requiref</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"skynet.codecache"</span><span class="token punctuation">,</span> codecache <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pop</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lua_gc</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> LUA_GCGEN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"lua_path"</span><span class="token punctuation">,</span><span class="token string">"./lualib/?.lua;./lualib/?/init.lua"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pushstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_setglobal</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"LUA_PATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cpath <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"lua_cpath"</span><span class="token punctuation">,</span><span class="token string">"./luaclib/?.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pushstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> cpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_setglobal</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"LUA_CPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"luaservice"</span><span class="token punctuation">,</span> <span class="token string">"./service/?.lua"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pushstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_setglobal</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"LUA_SERVICE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>preload <span class="token operator">=</span> <span class="token function">skynet_command</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"GETENV"</span><span class="token punctuation">,</span> <span class="token string">"preload"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pushstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> preload<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_setglobal</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"LUA_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lua_pushcfunction</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> traceback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">lua_gettop</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> loader <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"lualoader"</span><span class="token punctuation">,</span> <span class="token string">"./lualib/loader.lua"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">luaL_loadfile</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> LUA_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"Can't load %s : %s"</span><span class="token punctuation">,</span> loader<span class="token punctuation">,</span> <span class="token function">lua_tostring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">report_launcher_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">lua_pushlstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> args<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	r <span class="token operator">=</span> <span class="token function">lua_pcall</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> LUA_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">skynet_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"lua loader error : %s"</span><span class="token punctuation">,</span> <span class="token function">lua_tostring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">report_launcher_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">lua_settop</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lua_getfield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> LUA_REGISTRYINDEX<span class="token punctuation">,</span> <span class="token string">"memlimit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> LUA_TNUMBER<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">size_t</span> limit <span class="token operator">=</span> <span class="token function">lua_tointeger</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		l<span class="token operator">-></span>mem_limit <span class="token operator">=</span> limit<span class="token punctuation">;</span>
		<span class="token function">skynet_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"Set memory limit to %.2f M"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>limit <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">lua_pushnil</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">lua_setfield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> LUA_REGISTRYINDEX<span class="token punctuation">,</span> <span class="token string">"memlimit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">lua_pop</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lua_gc</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> LUA_GCRESTART<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这其中最重要是下面段代码。这段代码首先加载了loader.lua这个lua服务加载器，利用这个加载器去加载lua服务。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token comment">//获取loader.lua的路径</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> loader <span class="token operator">=</span> <span class="token function">optstring</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"lualoader"</span><span class="token punctuation">,</span> <span class="token string">"./lualib/loader.lua"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//加载loader.lua,r是加载结果</span>
<span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">luaL_loadfile</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> LUA_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">skynet_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"Can't load %s : %s"</span><span class="token punctuation">,</span> loader<span class="token punctuation">,</span> <span class="token function">lua_tostring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">report_launcher_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//把参数bootstrap压入栈中，准备传入loader中</span>
<span class="token function">lua_pushlstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> args<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//加载bootstrap服务。</span>
r <span class="token operator">=</span> <span class="token function">lua_pcall</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> LUA_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">skynet_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"lua loader error : %s"</span><span class="token punctuation">,</span> <span class="token function">lua_tostring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">report_launcher_error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如下是<code>loader.lua</code>的代码，第一部分，是找到对应服务文件，并加载它。第二部分是设置lua的包寻找路径，最后调用main函数启动这个服务。</p><pre class="line-numbers language-lua" data-language=lua><code class=language-lua><span class="token keyword">local</span> args <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">for</span> word <span class="token keyword">in</span> string<span class="token punctuation">.</span><span class="token function">gmatch</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">,</span> <span class="token string">"%S+"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
	table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> word<span class="token punctuation">)</span>
<span class="token keyword">end</span>

SERVICE_NAME <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token keyword">local</span> main<span class="token punctuation">,</span> pattern

<span class="token keyword">local</span> err <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">for</span> pat <span class="token keyword">in</span> string<span class="token punctuation">.</span><span class="token function">gmatch</span><span class="token punctuation">(</span>LUA_SERVICE<span class="token punctuation">,</span> <span class="token string">"([^;]+);*"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
	<span class="token keyword">local</span> filename <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span>pat<span class="token punctuation">,</span> <span class="token string">"?"</span><span class="token punctuation">,</span> SERVICE_NAME<span class="token punctuation">)</span>
	<span class="token keyword">local</span> f<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token function">loadfile</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token keyword">not</span> f <span class="token keyword">then</span>
		table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
	<span class="token keyword">else</span>
		pattern <span class="token operator">=</span> pat
		main <span class="token operator">=</span> f
		<span class="token keyword">break</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> main <span class="token keyword">then</span>
	<span class="token function">error</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

LUA_SERVICE <span class="token operator">=</span> <span class="token keyword">nil</span>
package<span class="token punctuation">.</span>path <span class="token punctuation">,</span> LUA_PATH <span class="token operator">=</span> LUA_PATH
package<span class="token punctuation">.</span>cpath <span class="token punctuation">,</span> LUA_CPATH <span class="token operator">=</span> LUA_CPATH

<span class="token keyword">local</span> service_path <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> <span class="token string">"(.*/)[^/?]+$"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> service_path <span class="token keyword">then</span>
	service_path <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span>service_path<span class="token punctuation">,</span> <span class="token string">"?"</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	package<span class="token punctuation">.</span>path <span class="token operator">=</span> service_path <span class="token operator">..</span> <span class="token string">"?.lua;"</span> <span class="token operator">..</span> package<span class="token punctuation">.</span>path
	SERVICE_PATH <span class="token operator">=</span> service_path
<span class="token keyword">else</span>
	<span class="token keyword">local</span> p <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> <span class="token string">"(.*/).+$"</span><span class="token punctuation">)</span>
	SERVICE_PATH <span class="token operator">=</span> p
<span class="token keyword">end</span>

<span class="token keyword">if</span> LUA_PRELOAD <span class="token keyword">then</span>
	<span class="token keyword">local</span> f <span class="token operator">=</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">loadfile</span><span class="token punctuation">(</span>LUA_PRELOAD<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">f</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
	LUA_PRELOAD <span class="token operator">=</span> <span class="token keyword">nil</span>
<span class="token keyword">end</span>

_G<span class="token punctuation">.</span>require <span class="token operator">=</span> <span class="token punctuation">(</span>require <span class="token string">"skynet.require"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>require

<span class="token function">main</span><span class="token punctuation">(</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> table<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后我们从lua层反过来看，还用上例bootstrap这个服务，服务代码如下。</p><pre class="line-numbers language-lua" data-language=lua><code class=language-lua><span class="token keyword">local</span> skynet <span class="token operator">=</span> require <span class="token string">"skynet"</span>
<span class="token keyword">local</span> harbor <span class="token operator">=</span> require <span class="token string">"skynet.harbor"</span>
<span class="token keyword">local</span> service <span class="token operator">=</span> require <span class="token string">"skynet.service"</span>
require <span class="token string">"skynet.manager"</span>	<span class="token comment">-- import skynet.launch, ...</span>

skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> standalone <span class="token operator">=</span> skynet<span class="token punctuation">.</span>getenv <span class="token string">"standalone"</span>

	<span class="token keyword">local</span> launcher <span class="token operator">=</span> <span class="token function">assert</span><span class="token punctuation">(</span>skynet<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token string">"snlua"</span><span class="token punctuation">,</span><span class="token string">"launcher"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	skynet<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">".launcher"</span><span class="token punctuation">,</span> launcher<span class="token punctuation">)</span>

	<span class="token keyword">local</span> harbor_id <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>skynet<span class="token punctuation">.</span>getenv <span class="token string">"harbor"</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> harbor_id <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
		<span class="token function">assert</span><span class="token punctuation">(</span>standalone <span class="token operator">==</span>  <span class="token keyword">nil</span><span class="token punctuation">)</span>
		standalone <span class="token operator">=</span> <span class="token keyword">true</span>
		skynet<span class="token punctuation">.</span><span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"standalone"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>

		<span class="token keyword">local</span> ok<span class="token punctuation">,</span> slave <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>skynet<span class="token punctuation">.</span>newservice<span class="token punctuation">,</span> <span class="token string">"cdummy"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
			skynet<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">end</span>
		skynet<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">".cslave"</span><span class="token punctuation">,</span> slave<span class="token punctuation">)</span>

	<span class="token keyword">else</span>
		<span class="token keyword">if</span> standalone <span class="token keyword">then</span>
			<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token function">pcall</span><span class="token punctuation">(</span>skynet<span class="token punctuation">.</span>newservice<span class="token punctuation">,</span><span class="token string">"cmaster"</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
				skynet<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>

		<span class="token keyword">local</span> ok<span class="token punctuation">,</span> slave <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span>skynet<span class="token punctuation">.</span>newservice<span class="token punctuation">,</span> <span class="token string">"cslave"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
			skynet<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">end</span>
		skynet<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">".cslave"</span><span class="token punctuation">,</span> slave<span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token keyword">if</span> standalone <span class="token keyword">then</span>
		<span class="token keyword">local</span> datacenter <span class="token operator">=</span> skynet<span class="token punctuation">.</span>newservice <span class="token string">"datacenterd"</span>
		skynet<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"DATACENTER"</span><span class="token punctuation">,</span> datacenter<span class="token punctuation">)</span>
	<span class="token keyword">end</span>
	skynet<span class="token punctuation">.</span>newservice <span class="token string">"service_mgr"</span>

	<span class="token keyword">local</span> enablessl <span class="token operator">=</span> skynet<span class="token punctuation">.</span>getenv <span class="token string">"enablessl"</span>
	<span class="token keyword">if</span> enablessl <span class="token keyword">then</span>
		service<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"ltls_holder"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">local</span> c <span class="token operator">=</span> require <span class="token string">"ltls.init.c"</span>
			c<span class="token punctuation">.</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">end</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token function">pcall</span><span class="token punctuation">(</span>skynet<span class="token punctuation">.</span>newservice<span class="token punctuation">,</span>skynet<span class="token punctuation">.</span>getenv <span class="token string">"start"</span> <span class="token keyword">or</span> <span class="token string">"main"</span><span class="token punctuation">)</span>
	skynet<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中很重要的就是这个<code>local launcher = assert(skynet.launch(&quot;snlua&quot;,&quot;launcher&quot;))</code>。<br>当我们去创建新服务，或者是初始化lua服务，都会给launcher这个服务发消息，它不仅仅充当着启动器的角色。</p><pre class="line-numbers language-lua" data-language=lua><code class=language-lua><span class="token keyword">function</span> skynet<span class="token punctuation">.</span><span class="token function">init_service</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>
	<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		skynet_require<span class="token punctuation">.</span><span class="token function">init_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
	<span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">xpcall</span><span class="token punctuation">(</span>main<span class="token punctuation">,</span> traceback<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
		skynet<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"init service failed: "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">".launcher"</span><span class="token punctuation">,</span><span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"ERROR"</span><span class="token punctuation">)</span>
		skynet<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span>
		skynet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">".launcher"</span><span class="token punctuation">,</span><span class="token string">"lua"</span><span class="token punctuation">,</span> <span class="token string">"LAUNCHOK"</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>


<span class="token keyword">function</span> skynet<span class="token punctuation">.</span><span class="token function">newservice</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> skynet<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">".launcher"</span><span class="token punctuation">,</span> <span class="token string">"lua"</span> <span class="token punctuation">,</span> <span class="token string">"LAUNCH"</span><span class="token punctuation">,</span> <span class="token string">"snlua"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而当创建新服务时，launcher服务会调用LAUNCH函数，然后再调用launch_service，而后又调用skynet.launch。</p><pre class="line-numbers language-lua" data-language=lua><code class=language-lua><span class="token keyword">function</span> command<span class="token punctuation">.</span><span class="token function">LAUNCH</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>

    <span class="token function">launch_service</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> NORET

<span class="token keyword">end</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">launch_service</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> param <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">...</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> inst <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> param<span class="token punctuation">)</span>
	<span class="token keyword">local</span> session <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> response <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> inst <span class="token keyword">then</span>
		services<span class="token punctuation">[</span>inst<span class="token punctuation">]</span> <span class="token operator">=</span> service <span class="token operator">..</span> <span class="token string">" "</span> <span class="token operator">..</span> param
		instance<span class="token punctuation">[</span>inst<span class="token punctuation">]</span> <span class="token operator">=</span> response
		launch_session<span class="token punctuation">[</span>inst<span class="token punctuation">]</span> <span class="token operator">=</span> session
	<span class="token keyword">else</span>
		<span class="token function">response</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token keyword">end</span>
	<span class="token keyword">return</span> inst
<span class="token keyword">end</span>

<span class="token keyword">function</span> skynet<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> addr <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">"LAUNCH"</span><span class="token punctuation">,</span> table<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">...</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> addr <span class="token keyword">then</span>
		<span class="token keyword">return</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>addr <span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而skynet.launch会调用skynet.core中的command，执行LAUNCH。会在<code>cmd_launch</code>函数中创建snlua加载类似于bootsrtap等lua服务。每个lua服务都会创建一个snlua虚拟机，lua服务之间形成沙盒，通过工作线程进行交互信息，信息在每个服务的结构体中，传递消息也仅仅是指针，这样的效率十分的高。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">command_func</span> cmd_funcs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"TIMEOUT"</span><span class="token punctuation">,</span> cmd_timeout <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"REG"</span><span class="token punctuation">,</span> cmd_reg <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"QUERY"</span><span class="token punctuation">,</span> cmd_query <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"NAME"</span><span class="token punctuation">,</span> cmd_name <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"EXIT"</span><span class="token punctuation">,</span> cmd_exit <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"KILL"</span><span class="token punctuation">,</span> cmd_kill <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"LAUNCH"</span><span class="token punctuation">,</span> cmd_launch <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"GETENV"</span><span class="token punctuation">,</span> cmd_getenv <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"SETENV"</span><span class="token punctuation">,</span> cmd_setenv <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"STARTTIME"</span><span class="token punctuation">,</span> cmd_starttime <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"ABORT"</span><span class="token punctuation">,</span> cmd_abort <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"MONITOR"</span><span class="token punctuation">,</span> cmd_monitor <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"STAT"</span><span class="token punctuation">,</span> cmd_stat <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"LOGON"</span><span class="token punctuation">,</span> cmd_logon <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"LOGOFF"</span><span class="token punctuation">,</span> cmd_logoff <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token string">"SIGNAL"</span><span class="token punctuation">,</span> cmd_signal <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#123;</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> 
<span class="token function">skynet_command</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> context<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> cmd <span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">command_func</span> <span class="token operator">*</span> method <span class="token operator">=</span> <span class="token operator">&amp;</span>cmd_funcs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>method<span class="token operator">-></span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> method<span class="token operator">-></span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> method<span class="token operator">-></span><span class="token function">func</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token operator">++</span>method<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>
<span class="token function">cmd_launch</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> context<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">size_t</span> sz <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> tmp<span class="token punctuation">[</span>sz<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">strcpy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span> args <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span> mod <span class="token operator">=</span> <span class="token function">strsep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token string">" \t\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	args <span class="token operator">=</span> <span class="token function">strsep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> inst <span class="token operator">=</span> <span class="token function">skynet_context_new</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>inst <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token function">id_to_hex</span><span class="token punctuation">(</span>context<span class="token operator">-></span>result<span class="token punctuation">,</span> inst<span class="token operator">-></span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> context<span class="token operator">-></span>result<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这就是lua服务的创建过程。</p><p>但是回到skynet.start这个函数中，服务启动时会先调用skynet.core中的callback函数。</p><pre class="line-numbers language-lua" data-language=lua><code class=language-lua><span class="token keyword">function</span> skynet<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>start_func<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>skynet<span class="token punctuation">.</span>dispatch_message<span class="token punctuation">)</span>
	init_thread <span class="token operator">=</span> skynet<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		skynet<span class="token punctuation">.</span><span class="token function">init_service</span><span class="token punctuation">(</span>start_func<span class="token punctuation">)</span>
		init_thread <span class="token operator">=</span> <span class="token keyword">nil</span>
	<span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>callback函数对应lcommand函数，函数首先从 Lua 堆栈中获取服务上下文和一个布尔值 <code>forward</code>。然后，检查堆栈上的第一个参数是否是一个函数，这个函数就是要设置为回调函数的 Lua 函数。从结果上，lcommand最后一定会把之前设置为NULL的回调，设回成_cb。而这个函数的作用就是设置lua服务的回调函数。</p><pre class="line-numbers language-c" data-language=c><code class=language-c>	luaL_Reg l<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
		<span class="token punctuation">&#123;</span> <span class="token string">"send"</span> <span class="token punctuation">,</span> lsend <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> <span class="token string">"genid"</span><span class="token punctuation">,</span> lgenid <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> <span class="token string">"redirect"</span><span class="token punctuation">,</span> lredirect <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> <span class="token string">"command"</span> <span class="token punctuation">,</span> lcommand <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> <span class="token string">"intcommand"</span><span class="token punctuation">,</span> lintcommand <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> <span class="token string">"addresscommand"</span><span class="token punctuation">,</span> laddresscommand <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> <span class="token string">"error"</span><span class="token punctuation">,</span> lerror <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> <span class="token string">"harbor"</span><span class="token punctuation">,</span> lharbor <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> <span class="token string">"callback"</span><span class="token punctuation">,</span> lcallback <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> <span class="token string">"trace"</span><span class="token punctuation">,</span> ltrace <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	
<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">lcallback</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> context <span class="token operator">=</span> <span class="token function">lua_touserdata</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token function">lua_upvalueindex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> forward <span class="token operator">=</span> <span class="token function">lua_toboolean</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">luaL_checktype</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>LUA_TFUNCTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_settop</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">callback_context</span> <span class="token operator">*</span> cb_ctx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">callback_context</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">lua_newuserdatauv</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>cb_ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cb_ctx<span class="token operator">-></span>L <span class="token operator">=</span> <span class="token function">lua_newthread</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pushcfunction</span><span class="token punctuation">(</span>cb_ctx<span class="token operator">-></span>L<span class="token punctuation">,</span> traceback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_setiuservalue</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_getfield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> LUA_REGISTRYINDEX<span class="token punctuation">,</span> <span class="token string">"callback_context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_setiuservalue</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_setfield</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> LUA_REGISTRYINDEX<span class="token punctuation">,</span> <span class="token string">"callback_context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_xmove</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> cb_ctx<span class="token operator">-></span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">skynet_callback</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cb_ctx<span class="token punctuation">,</span> <span class="token punctuation">(</span>forward<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">(</span>_forward_pre<span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">(</span>_cb_pre<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">_cb_pre</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> context<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> ud<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> session<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> source<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> msg<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">callback_context</span> <span class="token operator">*</span>cb_ctx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">callback_context</span> <span class="token operator">*</span><span class="token punctuation">)</span>ud<span class="token punctuation">;</span>
	<span class="token function">clear_last_context</span><span class="token punctuation">(</span>cb_ctx<span class="token operator">-></span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">skynet_callback</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ud<span class="token punctuation">,</span> _cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">_cb</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cb_ctx<span class="token punctuation">,</span> type<span class="token punctuation">,</span> session<span class="token punctuation">,</span> source<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">_forward_pre</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span>context<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ud<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> session<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> source<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">callback_context</span> <span class="token operator">*</span>cb_ctx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">callback_context</span> <span class="token operator">*</span><span class="token punctuation">)</span>ud<span class="token punctuation">;</span>
	<span class="token function">clear_last_context</span><span class="token punctuation">(</span>cb_ctx<span class="token operator">-></span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">skynet_callback</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ud<span class="token punctuation">,</span> forward_cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">forward_cb</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cb_ctx<span class="token punctuation">,</span> type<span class="token punctuation">,</span> session<span class="token punctuation">,</span> source<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">forward_cb</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> context<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> ud<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> session<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> source<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> msg<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">_cb</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ud<span class="token punctuation">,</span> type<span class="token punctuation">,</span> session<span class="token punctuation">,</span> source<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// don't delete msg in forward mode.</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在_cb中处理lua服务的数据。</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">_cb</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skynet_context</span> <span class="token operator">*</span> context<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> ud<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> session<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> source<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> msg<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">callback_context</span> <span class="token operator">*</span>cb_ctx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">callback_context</span> <span class="token operator">*</span><span class="token punctuation">)</span>ud<span class="token punctuation">;</span>
	lua_State <span class="token operator">*</span>L <span class="token operator">=</span> cb_ctx<span class="token operator">-></span>L<span class="token punctuation">;</span>
	<span class="token keyword">int</span> trace <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> r<span class="token punctuation">;</span>
	<span class="token function">lua_pushvalue</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">lua_pushinteger</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pushlightuserdata</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pushinteger</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pushinteger</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">lua_pushinteger</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

	r <span class="token operator">=</span> <span class="token function">lua_pcall</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> trace<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> LUA_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> self <span class="token operator">=</span> <span class="token function">skynet_command</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"REG"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> LUA_ERRRUN<span class="token operator">:</span>
		<span class="token function">skynet_error</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"lua call [%x to %s : %d msgsz = %d] error : "</span> KRED <span class="token string">"%s"</span> KNRM<span class="token punctuation">,</span> source <span class="token punctuation">,</span> self<span class="token punctuation">,</span> session<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> <span class="token function">lua_tostring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> LUA_ERRMEM<span class="token operator">:</span>
		<span class="token function">skynet_error</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"lua memory error : [%x to %s : %d]"</span><span class="token punctuation">,</span> source <span class="token punctuation">,</span> self<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token keyword">case</span> LUA_ERRERR<span class="token operator">:</span>
		<span class="token function">skynet_error</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"lua error in error : [%x to %s : %d]"</span><span class="token punctuation">,</span> source <span class="token punctuation">,</span> self<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

	<span class="token function">lua_pop</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>目前就看到这里，在分析过程中，存在很多值得深入的细节，好在网上已经有很多资料，可以找到。再遇感兴趣点的时候，会再次更新。</p></div><footer class=post-footer><div class=post-tags><a href=/tags/openProject/ rel=tag># openProject</a></div><div class=post-nav><div class=post-nav-item><a href=/share/install-app/ rel=prev title=ubuntu一些应用><i class="fa fa-chevron-left"></i> ubuntu一些应用</a></div><div class=post-nav-item><a href=/tl6088/ rel=next title=tl6088刷机之旅>tl6088刷机之旅 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class=comments id=disqus_thread><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; <span itemprop=copyrightYear>2023</span> <span class=with-love><i class="fa fa-heart"></i> </span><span class=author itemprop=copyrightHolder>ohayo</span></div><div class=powered-by>由 <a href=https://hexo.io/ rel=noopener target=_blank>Hexo</a> & <a href=https://theme-next.js.org/ rel=noopener target=_blank>NexT.Gemini</a> 强力驱动</div></div></footer><script src=https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin=anonymous></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/next-boot.js></script><script src=https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin=anonymous></script><script src=/js/third-party/search/local-search.js></script><script src=/js/third-party/pace.js></script><script class=next-config data-name=enableMath type=application/json>false</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css integrity="sha256-TThEtR+XalhWKkfF383YLOrI50NGNeIqrzS+q08afrY=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/copy-tex.min.css integrity="sha256-Wk20U9mS/kHGcSgkjSiRezW5exqT6wAOKwySOaLotXM=" crossorigin=anonymous><script class=next-config data-name=katex type=application/json>{"copy_tex_js":{"url":"https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/copy-tex.min.js","integrity":"sha256-etSqbSVF4+Lwe8MGk/Vanc1sR+mWv+qOG73fxWw9p94="}}</script><script src=/js/third-party/math/katex.js></script><script class=next-config data-name=disqus type=application/json>{"enable":true,"shortname":"ohayo1213","count":true,"i18n":{"disqus":"disqus"}}</script><script src=/js/third-party/comments/disqus.js></script></body></html>